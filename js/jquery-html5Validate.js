/*! jquery-html5Validate.js 基于HTML5表单验证的jQuery插件
 * 支持type="email", type="number", type="tel", type="url", type="zipcode", 以及多type, 如type="email|tel". 支持 step, min, max, required, pattern, multiple
 * 有4个自定义扩展属性 data-key, data-target, data-min, data-max
 * 文档：http://www.zhangxinxu.com/wordpress/?p=2857
 * 如果您有任何问题，可以邮件至zhangxinxu@zhangxinxu.com
 * create by zhangxinxu 2012-12-05
 * v1.0 beta
 on 2012-12-05 创建
 on 2012-12-06 兼容性调试
 on 2012-12-14 增加对multiple属性支持
 testRemind方法的最大宽度限制
 on 2012-12-17 增加submitEnabled参数
 on 2012-12-19 暴露testRemind方法的CSS参数
 on 2012-12-20 testRemind尖角设置overflow: hidden for IE6
 v1.0 publish on 2012-12-20
 v1.2 on 2012-12-21 尖角实际高度可能覆盖单复选框的问题，做了高度限制处理
 v1.2.1 on 2013-03-20 增加hidden提示时候的定位，以便在多屏下的时候提示可见
 v1.3 on 2013-06-19 新增validate参数，应对其他一些自定义的验证
 **/
(function(d,c){DBC2SBC=function(a){var h="",g,b;for(g=0;g<a.length;g++){b=a.charCodeAt(g);if(b>=65281&&b<=65373){h+=String.fromCharCode(a.charCodeAt(g)-65248)}else{if(b==12288){h+=String.fromCharCode(a.charCodeAt(g)-12288+32)}else{h+=a.charAt(g)}}}return h};d.testRemind=(function(){var g=d(window).width();var a=function(e){if(!e||!e.target){return}if(e.target.id!==d.testRemind.id&&d(e.target).parents("#"+d.testRemind.id).length===0){d.testRemind.hide()}},b=function(e){if(!e||!e.target){return}if(e.target.tagName.toLowerCase()!=="body"){d.testRemind.hide()}},h=function(){if(!d.testRemind.display){return}var e=d(window).width();if(Math.abs(g-e)>20){d.testRemind.hide();g=e}};return{id:"validateRemind",display:false,css:{},hide:function(){d("#"+this.id).remove();this.display=false;d(document).unbind({mousedown:a,keydown:b});d(window).unbind("resize",h)},bind:function(){d(document).bind({mousedown:a,keydown:b});d(window).bind("resize",h)}}})();OBJREG={EMAIL:"^[a-z0-9._%-]+@([a-z0-9-]+\\.)+[a-z]{2,4}$",NUMBER:"^\\-?\\d+(\\.\\d+)?$",URL:"^(http|https|ftp)\\:\\/\\/[a-z0-9\\-\\.]+\\.[a-z]{2,3}(:[a-z0-9]*)?\\/?([a-z0-9\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$",TEL:"^1\\d{10}$",ZIPCODE:"^\\d{6}$",prompt:{radio:"请选择一个选项",checkbox:"如果要继续，请选中此框",select:"请选择列表中的一项",email:"请输入电子邮件地址",url:"请输入网站地址",tel:"请输入手机号码",number:"请输入数值",date:"请输入日期",pattern:"内容格式不符合要求",empty:"请填写,此字段不能为空",multiple:"多条数据使用逗号分隔"}};d.html5Attr=function(a,f){if(!a||!f){return c}if(document.querySelector){return d(a).attr(f)}else{var b;b=a.getAttributeNode(f);return b&&b.nodeValue!==""?b.nodeValue:c}};d.html5Validate=(function(){return{isSupport:(function(){return d('<input type="email">').attr("type")==="email"})(),isEmpty:function(a,b){b=b||d.html5Attr(a,"placeholder");var f=a.value;if(a.type!=="password"){f=d.trim(f)}if(f===""||f===b){return true}return false},isRegex:function(a,l,p){var q=a.value,n=q,m=a.getAttribute("type")+"";m=m.replace(/\W+$/,"");if(m!=="password"){n=DBC2SBC(d.trim(q));n!==q&&d(a).val(n)}l=l||(function(){return d.html5Attr(a,"pattern")})()||(function(){return m&&d.map(m.split("|"),function(e){var f=OBJREG[e.toUpperCase()];if(f){return f}}).join("|")})();if(n===""||!l){return true}var o=d(a).hasProp("multiple"),b=new RegExp(l,p||"i");if(o&&!/^number|range$/i.test(m)){var r=true;d.each(n.split(","),function(f,e){e=d.trim(e);if(r&&!b.test(e)){r=false}});return r}else{return b.test(n)}return true},isOverflow:function(b){if(!b){return false}var a=d(b).attr("min"),m=d(b).attr("max"),j,l,n,k=b.value;if(!a&&!m){l=d(b).attr("data-min"),n=d(b).attr("data-max");if(l&&k.length<l){d(b).testRemind("至少输入"+l+"个字符");b.focus()}else{if(n&&k.length>n){d(b).testRemind("最多输入"+n+"个字符");d(b).selectRange(n,k.length)}else{return false}}}else{k=Number(k);j=Number(d(b).attr("step"))||1;if(a&&k<a){d(b).testRemind("值必须大于或等于"+a)}else{if(m&&k>m){d(b).testRemind("值必须小于或等于"+m)}else{if(j&&!/^\d+$/.test(Math.abs((k-a||0))/j)){d(b).testRemind("值无效")}else{return false}}}b.focus();b.select()}return true},isAllpass:function(j,k){if(!j){return true}var b={labelDrive:true};params=d.extend({},b,k||{});if(j.size&&j.size()==1&&j.get(0).tagName.toLowerCase()=="form"){j=j.find(":input")}else{if(j.tagName&&j.tagName.toLowerCase()=="form"){j=d(j).find(":input")}}var l=this;var i=true,a=function(w,t,z){var f=d(w).attr("data-key"),h=d("label[for='"+w.id+"']"),e="",g;if(params.labelDrive){g=d.html5Attr(w,"placeholder");h.each(function(){var m=d(this).text();if(m!==g){e+=m.replace(/\*|:|：/g,"")}})}if(d(w).isVisible()){if(t=="radio"||t=="checkbox"){d(w).testRemind(OBJREG.prompt[t],{align:"left"});w.focus()}else{if(z=="select"||z=="empty"){d(w).testRemind((z=="empty"&&e)?"您尚未输入"+e:OBJREG.prompt[z]);w.focus()}else{if(/^range|number$/i.test(t)&&Number(w.value)){d(w).testRemind("值无效");w.focus();w.select()}else{var u=OBJREG.prompt[t]||OBJREG.prompt.pattern;if(e){u="您输入的"+e+"格式不准确"}if(t!="number"&&d(w).hasProp("multiple")){u+="，"+OBJREG.prompt.multiple}d(w).testRemind(u);w.focus();w.select()}}}}else{var x=d(w).attr("data-target");var v=d("#"+x);if(v.size()==0){v=d("."+x)}var y="您尚未"+(f||(z=="empty"?"输入":"选择"))+((!/^radio|checkbox$/i.test(t)&&e)||"该项内容");if(v.size()){if(v.offset().top<d(window).scrollTop()){d(window).scrollTop(v.offset().top-50)
}v.testRemind(y)}else{alert(y)}}return false};j.each(function(){var f=this,g=f.getAttribute("type"),h=f.tagName.toLowerCase(),e=d(this).hasProp("required");if(g){var r=g.replace(/\W+$/,"");if(!params.hasTypeNormally&&d.html5Validate.isSupport&&g!=r){try{f.type=r}catch(s){}}g=r}if(i==false||f.disabled||g=="submit"||g=="reset"||g=="file"||g=="image"){return}if(g=="radio"&&e){var t=f.name?d("input[type='radio'][name='"+f.name+"']"):d(f),q=false;t.each(function(){if(q==false&&d(this).is(":checked")){q=true}});if(q==false){i=a(t.get(0),g,h)}}else{if(g=="checkbox"&&e&&!d(f).is(":checked")){i=a(f,g,h)}else{if(h=="select"&&e&&!f.value){i=a(f,g,h)}else{if((e&&l.isEmpty(f))||!(i=l.isRegex(f))){i?a(f,g,"empty"):a(f,g,h);i=false}else{if(l.isOverflow(f)){i=false}}}}}});return i}}})();d.fn.extend({isVisible:function(){return d(this).attr("type")!=="hidden"&&d(this).css("display")!=="none"&&d(this).css("visibility")!=="hidden"},hasProp:function(a){if(typeof a!=="string"){return c}var b=false;if(document.querySelector){var j=d(this).attr(a);if(j!==c&&j!==false){b=true}}else{var h=d(this).get(0).outerHTML,i=h.slice(0,h.search(/\/?['"]?>(?![^<]*<['"])/));b=new RegExp("\\s"+a+"\\b","i").test(i)}return b},selectRange:function(a,h){var b=d(this).get(0);if(b.createTextRange){var g=b.createTextRange();g.collapse(true);g.moveEnd("character",h);g.moveStart("character",a);g.select()}else{b.focus();b.setSelectionRange(a,h)}return this},testRemind:function(q,a){var u={size:6,align:"center",css:{maxWidth:280,backgroundColor:"#FFFFE0",borderColor:"#F7CE39",color:"#333",fontSize:"12px",padding:"5px 10px",zIndex:202}};a=a||{};a.css=d.extend({},u.css,a.css||d.testRemind.css);var v=d.extend({},u,a||{});if(!q||!d(this).isVisible()){return}var w={center:"50%",left:"15%",right:"85%"},r=w[v.align]||"50%";v.css.position="absolute";v.css.top="-99px";v.css.border="1px solid "+v.css.borderColor;if(d("#"+d.testRemind.id).size()){d.testRemind.hide()}this.remind=d('<div id="'+d.testRemind.id+'">'+q+"</div>").css(v.css);d(document.body).append(this.remind);var b;if(!window.XMLHttpRequest&&(b=parseInt(v.css.maxWidth))&&this.remind.width()>b){this.remind.width(b)}var t=d(this).offset(),o="top";if(!t){return d(this)}var p=t.top-this.remind.outerHeight()-v.size;if(p<d(document).scrollTop()){o="bottom";p=t.top+d(this).outerHeight()+v.size}var x=function(f){var g="transparent",k="dashed",j="solid";var h={},e={width:0,height:0,overflow:"hidden",borderWidth:v.size+"px",position:"absolute"},i={};if(f==="before"){h={top:{borderColor:[v.css.borderColor,g,g,g].join(" "),borderStyle:[j,k,k,k].join(" "),top:0},bottom:{borderColor:[g,g,v.css.borderColor,""].join(" "),borderStyle:[k,k,j,k].join(" "),bottom:0}}}else{if(f==="after"){h={top:{borderColor:v.css.backgroundColor+["",g,g,g].join(" "),borderStyle:[j,k,k,k].join(" "),top:-1},bottom:{borderColor:[g,g,v.css.backgroundColor,""].join(" "),borderStyle:[k,k,j,k].join(" "),bottom:-1}}}else{h=null;e=null;i=null;return null}}i=d.extend({},h[o],e);return d("<"+f+"></"+f+">").css(i)};var s={width:2*v.size,left:r,marginLeft:(-1*v.size)+"px",height:v.size,textIndent:0,overflow:"hidden",position:"absolute"};if(o=="top"){s.bottom=-1*v.size}else{s.top=-1*v.size}this.remind.css({left:t.left,top:p,marginLeft:d(this).outerWidth()*0.5-this.remind.outerWidth()*parseInt(r)/100}).prepend(d("<div></div>").css(s).append(x("before")).append(x("after")));d.testRemind.display=true;d.testRemind.bind();return d(this)},html5Validate:function(a,j){var h={novalidate:true,submitEnabled:true,validate:function(){return true}};var b=d.extend({},h,j||{});var i=d(this).find(":input");if(d.html5Validate.isSupport){if(b.novalidate){d(this).attr("novalidate","novalidate")}else{i.each(function(){var g=this.getAttribute("type")+"",e=g.replace(/\W+$/,"");if(g!=e){try{this.type=e}catch(f){}}});b.hasTypeNormally=true}}if(b.submitEnabled){d(this).find(":disabled").each(function(){if(/^image|submit$/.test(this.type)){d(this).removeAttr("disabled")}})}d(this).bind("submit",function(){if(d.html5Validate.isAllpass(i,b)&&b.validate()&&d.isFunction(a)){a.call(this)}return false});return d(this)}})})(jQuery);